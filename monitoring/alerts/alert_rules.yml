groups:
- name: starlight-api-critical
  rules:
  - alert: ServiceDown
    expr: up{job="starlight-api"} == 0
    for: 1m
    labels:
      severity: critical
      team: backend
    annotations:
      summary: "Starlight API service is down"
      description: "The Starlight API has been down for more than 1 minute."
      runbook_url: "https://docs.starlight.dev/runbooks/service-down"

  - alert: HighErrorRate
    expr: starlight:error_rate_5m > 0.05
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "High error rate detected"
      description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
      runbook_url: "https://docs.starlight.dev/runbooks/high-error-rate"

  - alert: DatabaseConnectionFailure
    expr: starlight_db_connection_pool_available == 0
    for: 30s
    labels:
      severity: critical
      team: backend
    annotations:
      summary: "Database connection pool exhausted"
      description: "No database connections available in the pool"
      runbook_url: "https://docs.starlight.dev/runbooks/db-connection-failure"

  - alert: RedisConnectionFailure
    expr: up{job="redis-exporter"} == 0
    for: 1m
    labels:
      severity: critical
      team: backend
    annotations:
      summary: "Redis connection failure"
      description: "Redis is not accessible"
      runbook_url: "https://docs.starlight.dev/runbooks/redis-failure"

- name: starlight-api-warnings
  rules:
  - alert: HighResponseTime
    expr: starlight:response_time_p95_5m > 1
    for: 5m
    labels:
      severity: warning
      team: backend
    annotations:
      summary: "High response time detected"
      description: "95th percentile response time is {{ $value }}s (threshold: 1s)"
      runbook_url: "https://docs.starlight.dev/runbooks/high-response-time"

  - alert: LowCacheHitRate
    expr: starlight:cache_hit_rate_5m < 0.7
    for: 10m
    labels:
      severity: warning
      team: backend
    annotations:
      summary: "Low cache hit rate"
      description: "Cache hit rate is {{ $value | humanizePercentage }} (threshold: 70%)"
      runbook_url: "https://docs.starlight.dev/runbooks/low-cache-hit-rate"

  - alert: HighAuthenticationFailures
    expr: starlight:auth_failure_rate_5m > 0.1
    for: 5m
    labels:
      severity: warning
      team: security
    annotations:
      summary: "High authentication failure rate"
      description: "Authentication failure rate is {{ $value | humanizePercentage }} (threshold: 10%)"
      runbook_url: "https://docs.starlight.dev/runbooks/auth-failures"

  - alert: HighMemoryUsage
    expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.8
    for: 5m
    labels:
      severity: warning
      team: infrastructure
    annotations:
      summary: "High memory usage"
      description: "Memory usage is {{ $value | humanizePercentage }} (threshold: 80%)"

  - alert: HighCPUUsage
    expr: (1 - avg(rate(node_cpu_seconds_total{mode="idle"}[5m]))) > 0.8
    for: 5m
    labels:
      severity: warning
      team: infrastructure
    annotations:
      summary: "High CPU usage"
      description: "CPU usage is {{ $value | humanizePercentage }} (threshold: 80%)"

  - alert: HighDiskUsage
    expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) > 0.85
    for: 5m
    labels:
      severity: warning
      team: infrastructure
    annotations:
      summary: "High disk usage"
      description: "Disk usage is {{ $value | humanizePercentage }} (threshold: 85%)"

- name: starlight-celery
  rules:
  - alert: CeleryWorkerDown
    expr: up{job="celery-exporter"} == 0
    for: 2m
    labels:
      severity: critical
      team: backend
    annotations:
      summary: "Celery worker is down"
      description: "Celery worker has been down for more than 2 minutes"

  - alert: HighCeleryTaskFailureRate
    expr: starlight:celery_task_failure_rate_5m > 0.1
    for: 5m
    labels:
      severity: warning
      team: backend
    annotations:
      summary: "High Celery task failure rate"
      description: "Celery task failure rate is {{ $value | humanizePercentage }} (threshold: 10%)"

  - alert: CeleryQueueBacklog
    expr: celery_queue_length > 1000
    for: 10m
    labels:
      severity: warning
      team: backend
    annotations:
      summary: "Celery queue backlog"
      description: "Celery queue has {{ $value }} pending tasks (threshold: 1000)"

- name: starlight-business
  rules:
  - alert: LowActiveUsers
    expr: starlight:active_users_1h < 10
    for: 30m
    labels:
      severity: warning
      team: product
    annotations:
      summary: "Low active user count"
      description: "Only {{ $value }} active users in the last hour"

  - alert: HighFileUploadFailures
    expr: rate(starlight_file_uploads_total{status="failure"}[5m]) / rate(starlight_file_uploads_total[5m]) > 0.05
    for: 5m
    labels:
      severity: warning
      team: backend
    annotations:
      summary: "High file upload failure rate"
      description: "File upload failure rate is {{ $value | humanizePercentage }} (threshold: 5%)"

- name: starlight-security
  rules:
  - alert: PotentialDDoSAttack
    expr: rate(starlight_requests_total[1m]) > 1000
    for: 2m
    labels:
      severity: critical
      team: security
    annotations:
      summary: "Potential DDoS attack detected"
      description: "Request rate is {{ $value }} requests/second (threshold: 1000/s)"

  - alert: MultipleFailedLogins
    expr: increase(starlight_auth_attempts_total{result="failure"}[5m]) > 50
    for: 1m
    labels:
      severity: warning
      team: security
    annotations:
      summary: "Multiple failed login attempts"
      description: "{{ $value }} failed login attempts in the last 5 minutes"

  - alert: UnauthorizedAccessAttempts
    expr: rate(starlight_requests_total{status_code="401"}[5m]) > 5
    for: 3m
    labels:
      severity: warning
      team: security
    annotations:
      summary: "High rate of unauthorized access attempts"
      description: "{{ $value }} unauthorized requests per second"
